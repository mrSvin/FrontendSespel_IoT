<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Анализ работы навигаторов</title>
    <link rel="shortcut icon" type="image/ico" th:href="@{/favicon.ico}"/>

    <link rel="stylesheet" type="text/css" href="../../css/styles_stanki.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/menu_buttons.css"/> <!-- Меню -->
    <link rel="stylesheet" type="text/css" href="../../css/styles_header.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/userscontrol.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/styles_energy.css"/>
    <link rel="stylesheet" type="text/css" href="../../css/alarm_styles.css"/>

    <link href="../../css/bootstrap.min.css" rel="stylesheet"/>
    <link href="../../css/bootstrap-datepicker3.css" rel="stylesheet" id="bootstrap-css"/>

    <script src="../../js/highcharts.js"></script>
    <script src="../../js/exporting.js"></script>
    <script src="../../js/export-data.js"></script>
    <script src="../../js/accessibility.js"></script>
    <script src="../../js/xrange.js"></script>

    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script src="../../js/bootstrap-3.3.0.min.js"></script>

    <script>
        $(function () {
            $('#datepicker').datepicker({
                format: "dd/mm/yyyy",
                language: 'ru',
                autoclose: true,
                todayHighlight: true,
                showOtherMonths: true,
                selectOtherMonths: true,
                autoclose: true,
                changeMonth: true,
                changeYear: true,
                orientation: "button"
            });
            <!--$("#datepicker").datepicker("update", new Date());  Задаем текущее время-->


            $('#button_obnovit').on("click", function () {
                var datas = $('#datepicker').data().datepicker.viewDate;
                var day = datas.getDate();
                var mes = datas.getMonth() + 1;
                var year = datas.getFullYear();

                name_data = year + "-" + mes + "-" + day;
                <!--console.log(name_data);-->
            });


        });

    </script>   <!--Календарь js-->

    <!--Календарь -->
    <script type="text/javascript" src="/js/bootstrap-datepicker.min.js"></script>
    <!--Календарь Русский язык-->
    <script type="text/javascript" src="/js/bootstrap-datepicker.ru.min.js"></script>

    <style>
        .preloader {
            /*фиксированное позиционирование*/
            position: fixed;
            /* координаты положения */
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            /* фоновый цвет элемента */
            /*background: #e0e0e0;*/
            /* размещаем блок над всеми элементами на странице (это значение должно быть больше, чем у любого другого позиционированного элемента на странице) */
            z-index: 1001;
        }

        .preloader__row {
            position: relative;
            top: 50%;
            left: 50%;
            width: 70px;
            height: 70px;
            margin-top: -35px;
            margin-left: -35px;
            text-align: center;
            animation: preloader-rotate 2s infinite linear;
        }

        .preloader__item {
            position: absolute;
            display: inline-block;
            top: 0;
            background-color: #337ab7;
            border-radius: 100%;
            width: 35px;
            height: 35px;
            animation: preloader-bounce 2s infinite ease-in-out;
        }

        .preloader__item:last-child {
            top: auto;
            bottom: 0;
            animation-delay: -1s;
        }

        @keyframes preloader-rotate {
            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes preloader-bounce {

            0%,
            100% {
                transform: scale(0);
            }

            50% {
                transform: scale(1);
            }
        }

        .loaded_hiding .preloader {
            transition: 0.3s opacity;
            opacity: 0;
        }

        .loaded .preloader {
            display: none;
        }
    </style>

</head>

<header>
    <div class="header-div">
        <a href="../../home" style="display: flex; align-items: flex-start;"><img src="../../images/logo_black.png" class="icon-logo-admin icon-alarm"/></a>
        <h1>Анализ работы навигаторов</h1>
        <div style="display: flex; flex-direction: row;">
            <div class="div_login_mail">
                <li></li>
                <p></p>
            </div>
            <div method="post" class="dropdown">
                <input type="image" alt="Avatar" class="avatar"/>
                <div class="dropdown-content">
                    <p id="role_vision"></p>
                    <p><img width="100" style="border-radius: 360px; margin-top:0; "/></p>
                    <div class="div_login_mail">
                        <li></li>
                        <p></p>
                    </div>
                    <div style=" display: block; border-bottom: 1px solid #e8eaed; margin-bottom: 5px; line-height: normal"></div>
                    <button id="admin" onclick="window.location.href = '/adminpanel/userscontrol';">Администрирование
                    </button>
                    <label class="switch">
                        <p>Светлая Темная</p>
                        <span class="slider round"><input type="checkbox" id='dark_button'/><span
                                class="slider_before round_before"></span></span>
                    </label>
                    <form th:action="@{/logout}" method="post">
                        <button class="follow" type="submit">
                            Выход
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>


</header>
<!--Шапка html-->
<body>
<div class="preloader">
    <div class="preloader__row">
        <div class="preloader__item"></div>
        <div class="preloader__item"></div>
    </div>
</div>
<!-- Загрузка страницы и темная тема-->
<script>
    var dark_theme_state = 0; <!--    переменная состояния темы страницы-->

    if (localStorage['dark_theme_state'] != null) {
        dark_theme_state = parseInt(window.localStorage['dark_theme_state']); // Если она уже локально задана сохраняем
    }

    if (dark_theme_state == 0) {
        $('.preloader').attr("style", `background: #f2f6f8`);
    } // присвоение цвета загрузочного меню
    else if (dark_theme_state == 1) {
        $('.preloader').attr("style", `background: #161821`);
    } // в двух цветах

    window.onload = function () { // прелоудер
        document.body.classList.add('loaded_hiding');
        window.setTimeout(function () {
            document.body.classList.add('loaded');
            document.body.classList.remove('loaded_hiding');
        }, 500);

        dark_theme(); // Вызов функции
        // Смена цвета по кнопке
        $("#dark_button").on("click", function () {
            dark_theme_state++; // увеличиваем счетчик
            if (dark_theme_state > 1) // если он больше 1, меняем на ноль
            {
                dark_theme_state = 0;
            }
            window.localStorage['dark_theme_state'] = dark_theme_state; // сохраняем переменную в локальном хранилище
            // Условия для смены цвета после нажатия на кнопку
            dark_theme();
        });
    }
</script>
<script src="/js/dark_theme.js"></script>

<div style="border: 1px solid #333;">
    <div style="overflow: hidden;">
        <div style="width: 100%;   margin: 2%;">
            <div style="display: flex; height: 400px; width: 55%;" id="container_do6"></div>
        </div>
    </div>  <!--ЭПП html-->
</div> <!--До 6 утра html-->

<div style="border: 1px solid #333;">
    <div style="overflow: hidden;">
        <div style="width: 100%;   margin: 2%;">
            <div class="img" style="float: left;"> <!--Вставляем изображение станка 1-->
                <div class="parent_image">
                    <img src="../images/navigator.png" class="stanok_img"/>
                    <figcaption style="margin: 1.5%; font-weight: bold; font-size: 150%; text-align: center">С 00:00 до 06:00</figcaption>
                </div>
            </div>
            <div style="display: flex; height: 400px; width: 55%;" id="container_do12"></div>
        </div>
    </div>  <!--ЭПП html-->
</div> <!--До 12 дня html-->

<div style="border: 1px solid #333;">
    <div style="overflow: hidden;">
        <div style="width: 100%;   margin: 2%;">
            <div class="img" style="float: left;"> <!--Вставляем изображение станка 1-->
                <div class="parent_image">
                    <img src="../images/navigator.png" class="stanok_img"/>
                    <figcaption style="margin: 1.5%; font-weight: bold; font-size: 150%; text-align: center">С 00:00 до 06:00</figcaption>
                </div>
            </div>
            <div style="display: flex; height: 400px; width: 55%;" id="container_do18"></div>
        </div>
    </div>  <!--ЭПП html-->
</div> <!--До 18 вечера html-->

<div style="border: 1px solid #333;">
    <div style="overflow: hidden;">
        <div style="width: 100%;   margin: 2%;">
            <div class="img" style="float: left;"> <!--Вставляем изображение станка 1-->
                <div class="parent_image">
                    <img src="../images/navigator.png" class="stanok_img"/>
                    <figcaption style="margin: 1.5%; font-weight: bold; font-size: 150%; text-align: center">С 00:00 до 06:00</figcaption>
                </div>
            </div>
            <div style="display: flex; height: 400px; width: 55%;" id="container_do24"></div>
        </div>
    </div>  <!--ЭПП html-->
</div> <!--До 24 ночи html-->


<!-- Скрипт вызова функции для выпадающего меню -->
<script src="/js/dropdown_menu.js"></script>



<!--<script>-->
<!--    var programName-->
<!--    var statusWork-->
<!--    var timeWork-->

<!--    var statusPause-->
<!--    var timePause-->

<!--    var statusOff-->
<!--    var timeOff-->

<!--    var statusAvar-->
<!--    var timeAvar-->

<!--    var statusNagruzka-->
<!--    var timeNagruzka-->

<!--    $.get( "http://192.168.3.41:8080/api/complex/dmg_dmu50_1_beginTime:2022-03-30_endTime:2022-03-30 23:59_statusTag:1",-->
<!--        function( data ) {-->
<!--        programName = data.programName;-->
<!--        statusWork = data.status;-->
<!--        timeWork = data.time;-->

<!--        showWork();-->
<!--    });-->

<!--    $.get( "http://192.168.3.41:8080/api/complex/dmg_dmu50_1_beginTime:2022-03-30_endTime:2022-03-30 23:59_statusTag:2",-->
<!--        function( data ) {-->
<!--            statusPause = data.status;-->
<!--            timePause = data.time;-->

<!--            showPause();-->
<!--        });-->

<!--    $.get( "http://192.168.3.41:8080/api/complex/dmg_dmu50_1_beginTime:2022-03-30_endTime:2022-03-30 23:59_statusTag:3",-->
<!--        function( data ) {-->
<!--            statusOff = data.status;-->
<!--            timeOff = data.time;-->

<!--            showOff();-->
<!--        });-->

<!--    $.get( "http://192.168.3.41:8080/api/complex/dmg_dmu50_1_beginTime:2022-03-30_endTime:2022-03-30 23:59_statusTag:4",-->
<!--        function( data ) {-->
<!--            statusAvar = data.status;-->
<!--            timeAvar = data.time;-->

<!--            showAvar();-->
<!--        });-->

<!--    $.get( "http://192.168.3.41:8080/api/complex/dmg_dmu50_1_beginTime:2022-03-30_endTime:2022-03-30 23:59_statusTag:5",-->
<!--        function( data ) {-->
<!--            statusNagruzka = data.status;-->
<!--            timeNagruzka = data.time;-->

<!--            showNagruzka();-->
<!--        });-->

<!--    function showWork() {-->
<!--        console.log("_______Work________")-->
<!--        console.log(programName);-->
<!--        console.log(statusWork);-->
<!--        console.log(timeWork);-->
<!--    }-->

<!--    function showPause() {-->
<!--        console.log("_______Pause________")-->
<!--        console.log(statusPause);-->
<!--        console.log(timePause);-->
<!--    }-->

<!--    function showOff() {-->
<!--        console.log("_______Off_______")-->
<!--        console.log(statusOff);-->
<!--        console.log(timeOff);-->
<!--    }-->

<!--    function showAvar() {-->
<!--        console.log("_______Avar_______")-->
<!--        console.log(statusAvar);-->
<!--        console.log(timeAvar);-->
<!--    }-->

<!--    function showNagruzka() {-->
<!--        console.log("_______Nagruzka_______")-->
<!--        console.log(statusNagruzka);-->
<!--        console.log(timeNagruzka);-->
<!--    }-->
<!--</script>-->

<script>
    function SetUserSetting(object) {
        $('.avatar').attr("src", object.imageUser); // картинка лого для папок на уровень ниже
        $('.dropdown-content img').attr("src", object.imageUser); // картинка лого для папок на уровень ниже
        $('.div_login_mail li').html(object.userName); // картинка лого для папок на уровень ниже
        $('.div_login_mail p').html(object.userMail); // картинка лого для папок на уровень ниже

        var role_status = object.userRole;

        if (role_status === "ROLE_ADMIN") {
            document.getElementById("role_vision").innerHTML = "Роль: Админ";
            document.getElementById("admin").style.display = "inline";

        } else if (role_status === "ROLE_USER") {
            document.getElementById("role_vision").innerHTML = "Роль: Пользователь"
            document.getElementById("admin").style.display = "none";
        }
    }


function ZeroTime(arrayTime) {
    let newArray = []

    for(let i=1; arrayTime.length-1 > i; i++)
    {
        newArray.push(arrayTime[i-1])

        if(arrayTime[i][0] - arrayTime[i-1][0]  > 60000) {
            console.log(i,"Спец логика между", new Date(arrayTime[i-1][0]+10800000).toISOString().slice(11, -5), 'И', new Date(arrayTime[i][0]+10800000).toISOString().slice(11, -5))
            newArray.push(Array(arrayTime[i-1][0] + 1000, 0))
            newArray.push(Array(arrayTime[i][0] - 1000, 0))
        }
    }
    return newArray
}

// for(let i=0; nurArray.length-1 > i; i++)
// {
//     console.log(new Date(nurArray[i][0]+10800000).toISOString().slice(11, -5), nurArray[i][1])
// }

// Функция для рисования графиков. Аргументы: id графика, массив данных
function highcharts(id, dataArray) {

        Highcharts.getJSON(
            'https://cdn.jsdelivr.net/gh/highcharts/highcharts@v7.0.0/samples/data/usdeur.json',
            function (data) {

                Highcharts.chart(id, {
                    chart: {
                        polar: true,
                        zoomType: 'x',
                        backgroundColor: 'none',
                    },
                    time: {
                        timezoneOffset: timezone
                    },
                    title: {
                        text: 'Хронология технологического процесса',
                        style: {
                            color: '#83addd'
                        }
                    },
                    xAxis: {
                        type: 'datetime'
                    },
                    yAxis: {
                        title: {
                            text: 'Амплитуда'
                        }
                    },
                    legend: {
                        backgroundColor: '#f2f6f8',
                        reversed: true
                    },
                    plotOptions: {
                        area: {
                            fillColor: {
                                linearGradient: {
                                    x1: 0,
                                    y1: 0
                                },
                                stops: [
                                    [0, Highcharts.getOptions().colors[0]],
                                    [1, Highcharts.color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                                ]
                            },
                            marker: {
                                radius: 2
                            },
                            lineWidth: 1,
                            states: {
                                hover: {
                                    lineWidth: 1
                                }
                            },
                            threshold: null
                        }
                    },
                    credits: {
                        enabled: false
                    },

                    series: [{
                        type: 'area',
                        name: 'Ток, А',
                        data: dataArray
                    },
                    ]
                });
            }
        );
    }

// Функция перебора массива из запроса с разложением на 4 массива по времени
function Perebor() {
        for(let i=0; massivArray.length > i; i++)
        {
             if(new Date('2022-04-02 06:00:00').getTime() > (massivArray[i].time))
             {
                do_6.push(Array(massivArray[i].time, parseFloat(massivArray[i].value)));
                continue
             }
            if(new Date('2022-04-02 12:00:00').getTime() > (massivArray[i].time))
            {
                do_12.push(Array(massivArray[i].time, parseFloat(massivArray[i].value)));
                continue
            }
            if(new Date('2022-04-02 18:00:00').getTime() > (massivArray[i].time))
            {
                do_18.push(Array(massivArray[i].time, parseFloat(massivArray[i].value)));
                continue
            }
            if(new Date('2022-04-02 23:59:59').getTime() > (massivArray[i].time))
            {
                do_24.push(Array(massivArray[i].time, parseFloat(massivArray[i].value)));
                continue
            }
        }

        const arraysTime = [[do_6,'container_do6'], [do_12,'container_do12'], [do_18,'container_do18'], [do_24,'container_do24']]

    $.map(arraysTime, function (data){
        data[0] = ZeroTime(data[0])
        highcharts(data[1], data[0])
    })

    }

const timezone = new Date().getTimezoneOffset()
var product = "4919A2A3-290F-419F-A45C-E0DC75F91DB3"
var startTime = "2022-04-02"
var endTime = "2022-04-03"

var massivArray

var do_6 = [];
var do_12 = [];
var do_18 = [];
var do_24 = [];


    var url = "http://192.168.3.41:8080/api/complex/powerNavigator/product_uuid:" + product  + "_startTime:" + startTime + "_endTime:" + endTime

    $.get( url,
        function( data ) {
            console.log(data)
            massivArray = data
            // Пользовательские настройки

            Perebor();
        });

    $.post( "http://192.168.3.41:8080/api/userInfo", function( data ) {
        SetUserSetting(data)
    });


</script>


</body>
</html>